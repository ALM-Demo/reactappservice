name: infra
'on':
  push:
    paths:
    - .github/workflows/web_app_deploy_workflow.yaml

env:
  AZURE_WEB_APP: "alm-app--dev"
  DOCKER_IMAGE_NAME: "docimg"
jobs:
  deploy-web-app:
    env:
      AZURE_ACR_ADMIN_ENABLED: true
      AZURE_ACR_NAME_PREFIX: almacr
      AZURE_DEPLOY_ENVIRONMENT: "dev"
      AZURE_RESOURCE_GROUP: ""
      AZURE_SUBSCRIPTION: "test"
      AZURE_WEB_APP_NAME_PREFIX: alm-app
      AZURE_WEB_APP_TYPE: "web_app"
      GITHUB_REPO_NAME: "reactappcontainer"
    runs-on: ubuntu-latest
    steps:
    - name: Set env
      run: |
       'echo "AZURE_WEB_APP_NAME_PREFIX=${AZURE_WEB_APP_NAME_PREFIX}-${AZURE_WEB_APP_TYPE}"
        >> $GITHUB_ENV

        echo "AZURE_WEB_APP_NAME=${AZURE_WEB_APP_NAME_PREFIX}-${GITHUB_REPO_NAME}-${AZURE_DEPLOY_ENVIRONMENT}"
        >> $GITHUB_ENV

        echo "AZURE_ACR_NAME=${AZURE_ACR_NAME_PREFIX}-${AZURE_DEPLOY_ENVIRONMENT}"
        >> $GITHUB_ENV

        echo "AZURE_WEB_APP_IMAGE_NAME=${GITHUB_REPO_NAME}-${AZURE_DEPLOY_ENVIRONMENT}"
        >> $GITHUB_ENV

    - name: Checkout Code
      uses: actions/checkout@v2
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: Get Timestamp
      run: 'echo "AZURE_WEB_APP_IMAGE_TAG=$(date ''+%Y-%m-%d-%H-%M-%S'')" >> $GITHUB_ENV'
    - name: Build Docker Image
      run: 'docker build .github/docker --file Dockerfile --tag "$AZURE_ACR_NAME.azurecr.io/$AZURE_WEB_APP_IMAGE_NAME:$AZURE_WEB_APP_IMAGE_TAG"'

    - name: Tag Docker Image
      run: 'docker tag $AZURE_ACR_NAME.azurecr.io/$AZURE_WEB_APP_IMAGE_NAME:$AZURE_WEB_APP_IMAGE_TAG $AZURE_ACR_NAME.azurecr.io/$AZURE_WEB_APP_IMAGE_NAME:latest'

    - name: Push Docker Images
      run: |
        docker push "$AZURE_ACR_NAME.azurecr.io/$AZURE_WEB_APP_IMAGE_NAME:$AZURE_WEB_APP_IMAGE_TAG"
        docker push "$AZURE_ACR_NAME.azurecr.io/$AZURE_WEB_APP_IMAGE_NAME:latest"

    - name: Login to ACR
      run: 'az acr login --name $AZURE_ACR_NAME'

    - name: Deploy New Image in Azure Web App
      run: 'az webapp config container set --name $AZURE_WEB_APP_NAME \

        --resource-group $AZURE_RESOURCE_GROUP \

        --docker-custom-image-name "DOCKER|$AZURE_ACR_NAME/$AZURE_WEB_APP_IMAGE_NAME:latest"'
